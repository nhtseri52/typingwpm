<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Typing Master - Full Version v20</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #3498db; --bg: #cfe2f5; --dark: #3c4a5c; --white: #ffffff; --success: #2ecc71; --danger: #e74c3c; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; transition: 0.2s; }
        body { background: var(--bg); display: flex; padding: 10px; gap: 10px; margin: 0; height: 100vh; overflow: hidden; flex-direction: column; }

        /* Modals */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .auth-card { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 380px; text-align: center; }
        .auth-card input { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 10px; outline: none; }
        .btn-auth { width: 100%; padding: 12px; border: none; border-radius: 10px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; }

        /* Sidebar Responsive */
        .sidebar { width: 100%; height: auto; display: flex; overflow-x: auto; gap: 8px; padding: 5px; flex-shrink: 0; }
        .nav-item { padding: 10px 15px; cursor: pointer; background: white; border-radius: 10px; white-space: nowrap; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: 500; }
        .nav-item.active { background: var(--primary); color: white; }

        .main-content { flex-grow: 1; background: white; border-radius: 20px; padding: 20px; overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.05); position: relative; }

        /* Typing Section */
        .word-display { font-size: 22px; padding: 15px; background: #fdfdfd; border: 1px solid #eee; border-radius: 15px; min-height: 120px; margin-bottom: 15px; line-height: 1.6; color: #bbb; text-align: left; }
        .w-active { background: #d1d8e0; color: #333; border-radius: 5px; padding: 0 5px; }
        .w-ok { color: var(--success); }
        .w-err { background: var(--danger); color: white; border-radius: 5px; padding: 0 5px; }

        .typing-bar { background: #adcce9; padding: 10px; border-radius: 12px; display: flex; gap: 8px; align-items: center; }
        .input-style { flex: 1; height: 45px; padding: 0 10px; border-radius: 8px; border: none; font-size: 18px; outline: none; }
        .timer-badge { background: #3c4a5c; color: white; height: 45px; width: 75px; display: flex; align-items: center; justify-content: center; font-size: 18px; border-radius: 8px; font-weight: bold; }
        
        .page { display: none; } .page.active { display: block; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #f0f0f0; }
        .btn-sm { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; margin: 2px; color: white; }

        @media (min-width: 768px) {
            body { flex-direction: row; padding: 20px; }
            .sidebar { width: 260px; flex-direction: column; overflow-x: visible; }
            .nav-item { font-size: 16px; padding: 15px 20px; }
        }
    </style>
</head>
<body>

    <div id="modal-login" class="modal" style="display: flex;">
        <div class="auth-card">
            <h2>Đăng Nhập</h2>
            <input type="text" id="li-u" placeholder="Username">
            <input type="password" id="li-p" placeholder="Password">
            <button class="btn-auth" onclick="app.login()">TRUY CẬP</button>
            <p onclick="app.showAuth('reg')" style="cursor:pointer; color:var(--primary); margin-top:15px; font-size:14px;">Chưa có nick? Đăng ký</p>
        </div>
    </div>

    <div id="modal-reg" class="modal">
        <div class="auth-card">
            <h2>Tạo Tài Khoản</h2>
            <input type="email" id="rg-e" placeholder="Gmail">
            <input type="text" id="rg-u" placeholder="Username mới">
            <input type="password" id="rg-p" placeholder="Password">
            <button class="btn-auth" onclick="app.register()">ĐĂNG KÝ</button>
            <p onclick="app.showAuth('login')" style="cursor:pointer; color:var(--primary); margin-top:15px; font-size:14px;">Quay lại đăng nhập</p>
        </div>
    </div>

    <div class="sidebar" id="sidebar-inject"></div>

    <div class="main-content">
        <div id="page-1" class="page active">
            <h1 id="t-m1" style="margin:0 0 15px 0;">Luyện Gõ</h1>
            <div id="display-1" class="word-display"></div>
            <div class="typing-bar">
                <input type="text" id="input-1" class="input-style" placeholder="Gõ chính xác..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                <div id="timer-1" class="timer-badge">1:00</div>
                <button class="btn-auth" style="width:45px; margin:0;" onclick="app.resetTyping()"><i class="fa-solid fa-sync"></i></button>
            </div>
        </div>

        <div id="page-2" class="page">
            <h1 id="t-m2">Hướng dẫn</h1>
            <img id="img-m2" src="" style="width:100%; max-width:600px; border-radius:15px; display:block; margin: 0 auto 20px;">
            <p style="text-align:center; color:#666;">Đặt tay đúng vị trí phím cơ sở để đạt tốc độ cao nhất.</p>
        </div>

        <div id="page-3" class="page">
            <h1>Bảng Xếp Hạng</h1>
            <table><thead><tr><th>Hạng</th><th>User</th><th>WPM</th><th>Độ chính xác</th></tr></thead><tbody id="rank-data"></tbody></table>
        </div>

        <div id="page-4" class="page">
            <h1>Cộng đồng & Chia sẻ</h1>
            <button class="btn-auth" style="width:auto; padding:10px 20px; margin-bottom:15px;" onclick="app.addPost()">+ Đăng bài gõ mới</button>
            <div style="overflow-x:auto">
                <table><thead><tr><th>Nội dung bài</th><th>Tác giả</th><th>Lượt Like</th><th>Hành động</th></tr></thead><tbody id="comm-data"></tbody></table>
            </div>
        </div>

        <div id="page-profile" class="page">
            <h1>Hồ sơ của tôi</h1>
            <div id="profile-area" style="background:#f9f9f9; padding:20px; border-radius:15px; line-height:2.5;"></div>
        </div>

        <div id="page-god" class="page">
            <h1 style="color:var(--danger)">GOD MODE CONTROL</h1>
            <div style="background:#fff3cd; padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid #ffeeba;">
                <h4>Cài đặt hệ thống</h4>
                Mục: <select id="sel-m" onchange="app.loadAdminSet()"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select>
                Tên: <input type="text" id="set-t">
                Ảnh: <input type="text" id="set-i">
                <button onclick="app.saveAdminSet()">Lưu</button>
            </div>
            <h4>Danh sách tài khoản</h4>
            <div style="overflow-x:auto"><table id="admin-user-list"></table></div>
        </div>
    </div>

    <script>
        const WORDS = "anh|em|gia|đình|trường|học|máy|tính|điện|thoại|bàn|phím|chuột|màn|hình|lập|trình|thông|minh|chiến|thắng|nỗ|lực|kiên|trì|thành|công|hạnh|phúc|việt|nam|hà|nội|sài|gòn|du|lịch|biển|nước|ăn|ngon|vui|vẻ|tự|tin|sáng|tạo|lịch|sử|toán|vật|lý|hóa|học|tiếng|anh|độc|lập|tự|do|tổ|quốc|bạn|bè|sinh|nhật|lễ|hội|xuân|hạ|thu|đông|vở|viết|kiến|thức|kỹ|năng|văn|phòng|chất|lượng|tài|chính|sức|khỏe|thể|thao|bóng|đá|gym|phim|ảnh|mạng|xã|hội|chụp|hình|nhà|khách|sạn|cà|phê|trà|sữa|phở|bún|cơm|trái|cây|cam|táo|bia|rượu".split('|');

        const app = {
            user: null, words: [], curIdx: 0, timer: null, timeLeft: 60, ok: 0, err: 0, isPlaying: false,
            conf: JSON.parse(localStorage.getItem('v20_cfg')) || { m1:"Tập gõ", m2:"Hướng dẫn", m3:"Xếp hạng", m4:"Cộng đồng", time:60, img2:"https://vcdn-vnexpress.vnecdn.net/2021/03/17/keyboard-1615969566-8835-1615969623.jpg" },

            init() {
                const s = localStorage.getItem('v20_ss');
                if(s) { 
                    this.user = JSON.parse(s);
                    document.getElementById('modal-login').style.display = 'none';
                    this.renderSidebar(); this.showPage(1);
                }
            },

            showAuth(t) {
                document.getElementById('modal-login').style.display = t==='login'?'flex':'none';
                document.getElementById('modal-reg').style.display = t==='reg'?'flex':'none';
            },

            register() {
                const u=document.getElementById('rg-u').value.trim(), p=document.getElementById('rg-p').value.trim(), e=document.getElementById('rg-e').value.trim();
                if(!u || !p) return alert("Vui lòng điền đủ Username và Pass!");
                if(localStorage.getItem('v20_u_'+u)) return alert("Nick này có người đăng ký rồi!");
                localStorage.setItem('v20_u_'+u, JSON.stringify({p, e, best:0}));
                alert("Đã tạo nick! Đăng nhập đi bro."); this.showAuth('login');
            },

            login() {
                const u=document.getElementById('li-u').value.trim(), p=document.getElementById('li-p').value.trim();
                if(u==='nhtseri' && p==='Locthinh1!') {
                    this.user = {u, isAdmin:true, e:'admin@pro.com', best:999};
                } else {
                    let d = JSON.parse(localStorage.getItem('v20_u_'+u));
                    if(!d || d.p !== p) return alert("Sai cmnr, check lại đi!");
                    this.user = {u, isAdmin:false, e:d.e, best:d.best||0};
                }
                localStorage.setItem('v20_ss', JSON.stringify(this.user)); location.reload();
            },

            renderSidebar() {
                let h = `<div class="side-box" style="display:flex; flex-direction:inherit; background:none; box-shadow:none; gap:8px;">`;
                [1,2,3,4].forEach(i => h += `<div class="nav-item" id="nav-${i}" onclick="app.showPage(${i})">${this.conf['m'+i]}</div>`);
                h += `<div class="nav-item" id="nav-profile" onclick="app.showPage('profile')">Hồ sơ</div>`;
                if(this.user.isAdmin) h += `<div class="nav-item" style="color:red" onclick="app.showPage('god')">GOD MODE</div>`;
                h += `<div class="nav-item" onclick="app.logout()">Đăng xuất</div></div>`;
                document.getElementById('sidebar-inject').innerHTML = h;
            },

            showPage(id) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.getElementById('page-'+id).classList.add('active');
                if(document.getElementById('nav-'+id)) document.getElementById('nav-'+id).classList.add('active');
                if(id === 1) this.resetTyping();
                if(id === 3) this.renderRank();
                if(id === 4) this.renderComm();
                if(id === 'profile') this.renderProfile();
                if(id === 'god') this.renderAdmin();
                if(id === 2) document.getElementById('img-m2').src = this.conf.img2;
            },

            resetTyping(customText = null) {
                clearInterval(this.timer); this.timeLeft = this.conf.time; this.curIdx = 0; this.ok = 0; this.err = 0; this.isPlaying = false;
                document.getElementById('timer-1').innerText = "1:00";
                document.getElementById('input-1').value = ""; document.getElementById('input-1').disabled = false;
                if(customText) {
                    this.words = customText.split(/\s+/).filter(x => x.length > 0);
                } else {
                    this.words = Array.from({length:30}, () => WORDS[Math.floor(Math.random()*WORDS.length)]);
                }
                document.getElementById('display-1').innerHTML = this.words.map((w,i) => `<span id="w-${i}" class="${i===0?'w-active':''}">${w}</span>`).join(" ");
            },

            handleInput(e) {
                if(!this.isPlaying) {
                    this.isPlaying = true;
                    this.timer = setInterval(() => {
                        this.timeLeft--;
                        document.getElementById('timer-1').innerText = `0:${this.timeLeft < 10 ? '0'+this.timeLeft : this.timeLeft}`;
                        if(this.timeLeft <= 0) this.finish();
                    }, 1000);
                }
                if(e.target.value.endsWith(" ")) {
                    // FIX LỖI VIẾT HOA MOBILE: Chuyển về lowercase để so sánh
                    let typed = e.target.value.trim().toLowerCase();
                    let target = this.words[this.curIdx].toLowerCase();
                    let el = document.getElementById('w-'+this.curIdx);
                    if(typed === target) { el.className = 'w-ok'; this.ok++; }
                    else { el.className = 'w-err'; this.err++; }
                    this.curIdx++;
                    if(this.curIdx < this.words.length) {
                        document.getElementById('w-'+this.curIdx).className = 'w-active';
                        document.getElementById('w-'+this.curIdx).scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else { this.finish(); }
                    e.target.value = "";
                }
            },

            finish() {
                clearInterval(this.timer);
                const acc = Math.round((this.ok / (this.ok + this.err)) * 100) || 0;
                alert(`Kết quả: ${this.ok} WPM | Chính xác: ${acc}%`);
                if(this.ok > this.user.best) {
                    this.user.best = this.ok;
                    localStorage.setItem('v20_ss', JSON.stringify(this.user));
                    let d = JSON.parse(localStorage.getItem('v20_u_'+this.user.u));
                    if(d) { d.best = this.ok; localStorage.setItem('v20_u_'+this.user.u, JSON.stringify(d)); }
                }
                // Save Rank
                let rs = JSON.parse(localStorage.getItem('v20_ranks') || "[]");
                rs.push({u:this.user.u, wpm:this.ok, acc});
                rs.sort((a,b) => b.wpm - a.wpm);
                localStorage.setItem('v20_ranks', JSON.stringify(rs.slice(0,10)));
                this.resetTyping();
            },

            renderRank() {
                const rs = JSON.parse(localStorage.getItem('v20_ranks') || "[]");
                document.getElementById('rank-data').innerHTML = rs.map((r,i) => `<tr><td>${i+1}</td><td>${r.u}</td><td>${r.wpm}</td><td>${r.acc}%</td></tr>`).join("");
            },

            renderProfile() {
                document.getElementById('profile-area').innerHTML = `
                    <b>Tên tài khoản:</b> ${this.user.u}<br>
                    <b>Email liên kết:</b> ${this.user.e}<br>
                    <b>Kỷ lục cao nhất:</b> <span style="color:var(--primary); font-size:20px;">${this.user.best} WPM</span>
                `;
            },

            // CỘNG ĐỒNG
            renderComm() {
                let ps = JSON.parse(localStorage.getItem('v20_posts') || "[]");
                document.getElementById('comm-data').innerHTML = ps.map((p,i) => {
                    let liked = p.likers && p.likers.includes(this.user.u);
                    return `<tr>
                        <td><b>${p.t}</b></td><td>${p.u}</td><td>${p.l || 0} ❤️</td>
                        <td>
                            <button class="btn-sm" style="background:${liked?'var(--danger)':'var(--primary)'}" onclick="app.toggleLike(${i})">${liked?'Bỏ thích':'Thích'}</button>
                            <button class="btn-sm" style="background:var(--success)" onclick="app.goTyping(${i})">Tập gõ bài này</button>
                        </td>
                    </tr>`}).join("");
            },
            toggleLike(i) {
                let ps = JSON.parse(localStorage.getItem('v20_posts'));
                if(!ps[i].likers) ps[i].likers = [];
                let idx = ps[i].likers.indexOf(this.user.u);
                if(idx === -1) { ps[i].likers.push(this.user.u); ps[i].l = (ps[i].l || 0) + 1; }
                else { ps[i].likers.splice(idx, 1); ps[i].l = (ps[i].l || 0) - 1; }
                localStorage.setItem('v20_posts', JSON.stringify(ps)); this.renderComm();
            },
            goTyping(i) {
                let ps = JSON.parse(localStorage.getItem('v20_posts'));
                this.showPage(1); this.resetTyping(ps[i].c);
            },
            addPost() {
                const t = prompt("Tiêu đề bài viết:"), c = prompt("Nội dung gõ:");
                if(t && c) {
                    let ps = JSON.parse(localStorage.getItem('v20_posts') || "[]");
                    ps.unshift({t, c, u:this.user.u, l:0, likers:[]});
                    localStorage.setItem('v20_posts', JSON.stringify(ps)); this.renderComm();
                }
            },

            // ADMIN
            renderAdmin() {
                let h = '<thead><tr><th>User</th><th>Pass</th><th>Gmail</th><th>Xóa</th></tr></thead><tbody>';
                for(let i=0; i<localStorage.length; i++) {
                    let k = localStorage.key(i);
                    if(k.startsWith('v20_u_')) {
                        let d = JSON.parse(localStorage.getItem(k));
                        h += `<tr><td>${k.replace('v20_u_','')}</td><td>${d.p}</td><td>${d.e}</td><td><button onclick="app.delU('${k}')">Xóa</button></td></tr>`;
                    }
                }
                document.getElementById('admin-user-list').innerHTML = h + '</tbody>';
            },
            loadAdminSet() { document.getElementById('set-t').value = this.conf['m'+document.getElementById('sel-m').value]; },
            saveAdminSet() {
                const m = document.getElementById('sel-m').value;
                this.conf['m'+m] = document.getElementById('set-t').value;
                if(m=='2' && document.getElementById('set-i').value) this.conf.img2 = document.getElementById('set-i').value;
                localStorage.setItem('v20_cfg', JSON.stringify(this.conf)); location.reload();
            },
            delU(k) { if(confirm("Xóa user này?")) { localStorage.removeItem(k); this.renderAdmin(); } },
            logout() { localStorage.removeItem('v20_ss'); location.reload(); }
        };

        document.getElementById('input-1').addEventListener('input', (e) => app.handleInput(e));
        window.onload = () => app.init();
    </script>
</body>
</html>
