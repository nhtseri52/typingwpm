<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN OMNI V120 - OVERLORD SYSTEM</title>
    
    <style>
        :root {
            --bg-deep: #020617; --bg-surface: #0f172a; --bg-accent: #1e293b;
            --primary: #3b82f6; --primary-glow: rgba(59, 130, 246, 0.5);
            --secondary: #8b5cf6; --text-main: #f1f5f9; --text-muted: #64748b;
            --border: #334155; --success: #22c55e; --danger: #ef4444;
            --font-ui: 'Inter', system-ui, sans-serif; --font-mono: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { font-family: var(--font-ui); background: var(--bg-deep); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }

        /* SCROLLBAR CUSTOM */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        /* AUTHENTICATION PORTAL */
        #auth-portal {
            position: fixed; inset: 0; background: radial-gradient(circle at center, #1e293b, #020617);
            z-index: 10000; display: flex; align-items: center; justify-content: center;
        }
        .auth-container {
            width: 1100px; height: 700px; background: var(--bg-surface); border-radius: 40px;
            display: flex; overflow: hidden; border: 1px solid var(--border); box-shadow: 0 0 100px rgba(0,0,0,0.8);
        }
        .auth-aside {
            flex: 1; background: linear-gradient(160deg, #1e3a8a, #4338ca); padding: 60px;
            display: flex; flex-direction: column; justify-content: center; position: relative;
        }
        .auth-aside::before {
            content: ""; position: absolute; inset: 0; opacity: 0.1;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M54.627 0l.83.827L30.827 25.453l-.827-.827L54.627 0zM5.373 60l-.83-.827L29.173 34.547l.827.827L5.373 60z' fill='%23ffffff' fill-opacity='1' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        .auth-form-wrap { flex: 1.2; padding: 80px; position: relative; background: var(--bg-surface); overflow-y: auto; }
        .form-identity { display: none; }
        .form-identity.active { display: block; animation: titanFade 0.6s ease; }

        /* SIDEBAR NAVIGATION */
        .sidebar {
            width: 320px; background: var(--bg-surface); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 100;
        }
        .sidebar-brand {
            padding: 40px 30px; display: flex; align-items: center; gap: 15px;
            font-size: 24px; font-weight: 900; background: rgba(0,0,0,0.2);
        }
        .nav-group { flex: 1; padding: 30px 15px; }
        .nav-label { font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin: 20px 0 10px 15px; letter-spacing: 2px; }
        .nav-btn {
            display: flex; align-items: center; gap: 15px; padding: 16px 20px; border-radius: 14px;
            color: var(--text-muted); cursor: pointer; transition: 0.3s; font-weight: 600; text-decoration: none;
        }
        .nav-btn:hover { background: var(--bg-accent); color: white; transform: translateX(5px); }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 10px 20px var(--primary-glow); }

        /* MAIN CONTENT AREA */
        .viewport { flex: 1; display: flex; flex-direction: column; position: relative; background: #0b1120; }
        .header {
            height: 100px; padding: 0 50px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; background: var(--bg-surface);
        }
        .scroller { flex: 1; padding: 50px; overflow-y: auto; }
        .section { display: none; animation: titanUp 0.6s cubic-bezier(0.23, 1, 0.32, 1); }
        .section.active { display: block; }

        /* TYPING ENGINE V120 */
        .engine-card { background: var(--bg-surface); border-radius: 30px; border: 1px solid var(--border); padding: 50px; position: relative; }
        .word-display {
            background: #020617; border-radius: 20px; padding: 40px; font-size: 38px; line-height: 1.8;
            height: 160px; overflow: hidden; position: relative; font-family: var(--font-mono); margin-bottom: 40px;
            border: 1px solid var(--bg-accent);
        }
        .word-track { position: absolute; transition: 0.35s ease; width: 100%; }
        .word-track span { color: #334155; margin-right: 25px; display: inline-block; transition: 0.2s; }
        .word-track .active-word { color: #fff; background: var(--bg-accent); border-radius: 8px; padding: 0 10px; }
        .word-track .ok { color: var(--success); }
        .word-track .err { color: var(--danger); background: rgba(239, 68, 68, 0.1); border-radius: 8px; }

        .input-zone { display: flex; gap: 20px; }
        .titan-input {
            flex: 1; background: var(--bg-deep); border: 2px solid var(--border); padding: 25px 40px;
            border-radius: 20px; color: white; font-size: 32px; font-family: var(--font-mono);
        }
        .titan-input:focus { border-color: var(--primary); box-shadow: 0 0 40px rgba(59, 130, 246, 0.1); }

        /* DATA TABLES */
        .table-wrap { background: var(--bg-surface); border-radius: 24px; border: 1px solid var(--border); overflow: hidden; }
        .titan-table { width: 100%; border-collapse: collapse; }
        .titan-table th { background: rgba(255,255,255,0.03); padding: 20px; text-align: left; font-size: 12px; color: var(--text-muted); text-transform: uppercase; }
        .titan-table td { padding: 22px 20px; border-bottom: 1px solid var(--border); }
        .titan-table tr:hover td { background: rgba(255,255,255,0.02); }

        /* ADMIN SPECIFIC */
        .admin-badge { padding: 4px 12px; background: var(--danger); color: white; border-radius: 6px; font-size: 10px; font-weight: 900; }
        .row-action { display: flex; gap: 10px; }
        .btn-mini { padding: 8px 15px; border-radius: 8px; font-size: 12px; cursor: pointer; border: none; font-weight: 700; }

        /* UI BUTTONS */
        .btn-titan { padding: 15px 30px; border-radius: 15px; font-weight: 700; cursor: pointer; border: none; display: flex; align-items: center; gap: 10px; transition: 0.3s; }
        .btn-p { background: var(--primary); color: white; }
        .btn-p:hover { background: #2563eb; transform: translateY(-3px); box-shadow: 0 10px 20px var(--primary-glow); }

        /* ANIMATIONS */
        @keyframes titanFade { from { opacity: 0; } to { opacity: 1; } }
        @keyframes titanUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        /* MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(10px); }
        .modal-box { background: var(--bg-surface); width: 700px; padding: 50px; border-radius: 30px; border: 1px solid var(--border); }
        .form-ctrl { width: 100%; padding: 15px; background: var(--bg-deep); border: 1px solid var(--border); border-radius: 12px; color: white; margin-bottom: 20px; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <div id="auth-portal">
        <div class="auth-container">
            <div class="auth-aside">
                <i class="fa-solid fa-crown" style="font-size: 70px; margin-bottom: 30px;"></i>
                <h1 style="font-size: 40px; font-weight: 900;">TITAN OVERLORD</h1>
                <p style="font-size: 18px; opacity: 0.8; margin-top: 15px;">Hệ thống tối cao quản trị gõ phím chuyên nghiệp.</p>
                <div style="margin-top: 50px;">
                    <p style="font-size: 13px; color: rgba(255,255,255,0.6);">HƯỚNG DẪN TRUY CẬP ADMIN:</p>
                    <p style="font-weight: 700;">Đăng ký với Username: <span style="color: #fbbf24;">admin</span></p>
                </div>
            </div>
            <div class="auth-form-wrap">
                <div id="auth-login" class="form-identity active">
                    <h2 style="font-size: 36px; margin-bottom: 10px;">Đăng nhập</h2>
                    <p style="color: var(--text-muted); margin-bottom: 40px;">Chào mừng Sếp quay trở lại.</p>
                    <div style="margin-bottom: 25px;">
                        <label style="display:block; margin-bottom: 10px; font-size: 13px;">USERNAME</label>
                        <input type="text" id="in-user" class="form-ctrl" placeholder="admin hoặc tên của bạn...">
                    </div>
                    <div style="margin-bottom: 30px;">
                        <label style="display:block; margin-bottom: 10px; font-size: 13px;">PASSWORD</label>
                        <input type="password" id="in-pass" class="form-ctrl" placeholder="••••••••">
                    </div>
                    <button class="btn-titan btn-p" style="width: 100%; justify-content: center;" onclick="OverlordAuth.login()">
                        TRUY CẬP <i class="fa-solid fa-unlock"></i>
                    </button>
                    <p style="text-align: center; margin-top: 30px; color: var(--text-muted);">
                        Chưa có tài khoản? <a href="#" onclick="OverlordAuth.tab('reg')" style="color: var(--primary);">Đăng ký tài khoản mới</a>
                    </p>
                </div>
                <div id="auth-reg" class="form-identity">
                    <h2 style="font-size: 36px; margin-bottom: 10px;">Đăng ký</h2>
                    <p style="color: var(--text-muted); margin-bottom: 30px;">Tạo hồ sơ mới để lưu kỷ lục.</p>
                    <input type="text" id="re-user" class="form-ctrl" placeholder="Nhập tên tài khoản (dùng 'admin' để có quyền sếp)">
                    <input type="password" id="re-pass" class="form-ctrl" placeholder="Mật khẩu">
                    <input type="password" id="re-pass2" class="form-ctrl" placeholder="Xác nhận mật khẩu">
                    <button class="btn-titan btn-p" style="width: 100%; justify-content: center;" onclick="OverlordAuth.register()">
                        KHỞI TẠO TÀI KHOẢN <i class="fa-solid fa-user-plus"></i>
                    </button>
                    <p style="text-align: center; margin-top: 30px; color: var(--text-muted);">
                        Đã có tài khoản? <a href="#" onclick="OverlordAuth.tab('login')" style="color: var(--primary);">Quay lại đăng nhập</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <aside class="sidebar">
        <div class="sidebar-brand">
            <div style="width: 45px; height: 45px; background: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <i class="fa-solid fa-bolt"></i>
            </div>
            TITAN OMNI
        </div>
        <nav class="nav-group">
            <div class="nav-label">Khu vực luyện tập</div>
            <div class="nav-btn active" onclick="OverlordApp.route('home')">
                <i class="fa-solid fa-keyboard"></i> Bàn phím chiến thần
            </div>
            <div class="nav-btn" onclick="OverlordApp.route('community')">
                <i class="fa-solid fa-earth-asia"></i> Thư viện cộng đồng
            </div>
            <div class="nav-btn" onclick="OverlordApp.route('ranking')">
                <i class="fa-solid fa-trophy"></i> Bảng vàng danh dự
            </div>

            <div id="admin-menu-slot"></div> </nav>
        
        <div style="padding: 25px; background: rgba(0,0,0,0.2); border-top: 1px solid var(--border);">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <div id="user-avatar" style="width: 50px; height: 50px; border-radius: 15px; background: var(--bg-accent); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; border: 1px solid var(--primary);">?</div>
                <div>
                    <p id="user-name" style="font-weight: 800; font-size: 15px;">UNKNWN</p>
                    <p id="user-role-badge" style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Member</p>
                </div>
            </div>
            <button class="btn-titan" style="width: 100%; background: #1e293b; color: var(--danger);" onclick="OverlordAuth.logout()">
                <i class="fa-solid fa-power-off"></i> ĐĂNG XUẤT
            </button>
        </div>
    </aside>

    <main class="viewport">
        <header class="header">
            <div>
                <h2 id="view-title">DASHBOARD</h2>
                <p id="view-subtitle" style="font-size: 13px; color: var(--text-muted);">Hệ thống đang hoạt động bình thường.</p>
            </div>
            <div style="display: flex; align-items: center; gap: 30px;">
                <div style="text-align: right;">
                    <p style="font-size: 11px; color: var(--text-muted);">GIỜ HỆ THỐNG:</p>
                    <p id="timer-clock" style="font-weight: 800; font-family: var(--font-mono);">00:00:00</p>
                </div>
                <button class="btn-titan btn-p" onclick="OverlordEngine.reset()">
                    <i class="fa-solid fa-play"></i> BẮT ĐẦU MỚI
                </button>
            </div>
        </header>

        <section class="scroller">
            <div id="v-home" class="section active">
                <div class="engine-card">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 40px;">
                        <div style="text-align: center; background: var(--bg-deep); padding: 20px 40px; border-radius: 20px; border: 1px solid var(--border);">
                            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">WPM (TỐC ĐỘ)</p>
                            <h2 id="stat-wpm" style="font-size: 48px; color: var(--primary);">0</h2>
                        </div>
                        <div style="text-align: center; background: var(--bg-deep); padding: 20px 40px; border-radius: 20px; border: 1px solid var(--border);">
                            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">ACCURACY</p>
                            <h2 id="stat-acc" style="font-size: 48px; color: var(--success);">0%</h2>
                        </div>
                        <div style="text-align: center; background: var(--primary); padding: 20px 40px; border-radius: 20px; width: 220px;">
                            <p style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 5px;">TIME LEFT</p>
                            <h2 id="stat-timer" style="font-size: 48px; font-family: var(--font-mono);">1:00</h2>
                        </div>
                    </div>

                    <div class="word-display">
                        <div id="word-rail" class="word-track"></div>
                    </div>

                    <div class="input-zone">
                        <input type="text" id="overlord-typer" class="titan-input" placeholder="Gõ từ tại đây..." autocomplete="off">
                        <button class="btn-titan" style="background: var(--bg-accent); padding: 0 40px;" onclick="OverlordEngine.reset()">
                            <i class="fa-solid fa-rotate-right" style="font-size: 24px;"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="v-community" class="section">
                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 40px;">
                    <div>
                        <h1>THƯ VIỆN CỘNG ĐỒNG</h1>
                        <p style="color: var(--text-muted);">Dưới đây là các văn bản được seeding sẵn cho bro luyện tập.</p>
                    </div>
                    <button class="btn-titan btn-p" onclick="OverlordUI.toggleModal('m-post', true)">+ CHIA SẺ VĂN BẢN</button>
                </div>
                <div class="table-wrap">
                    <table class="titan-table">
                        <thead>
                            <tr>
                                <th width="100">DẠNG</th>
                                <th>TIÊU ĐỀ BÀI TẬP</th>
                                <th width="150">ĐỘ DÀI</th>
                                <th width="150">HOÀN THÀNH</th>
                                <th width="150">HÀNH ĐỘNG</th>
                            </tr>
                        </thead>
                        <tbody id="comm-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="v-admin" class="section">
                <h1 style="color: var(--danger); margin-bottom: 10px;"><i class="fa-solid fa-user-shield"></i> HỆ THỐNG QUẢN TRỊ TỐI CAO</h1>
                <p style="color: var(--text-muted); margin-bottom: 40px;">Bro đang nắm quyền điều khiển toàn bộ Database của Titan.</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div class="table-wrap">
                        <div style="padding: 20px; border-bottom: 1px solid var(--border); font-weight: 800;">QUẢN LÝ NGƯỜI DÙNG</div>
                        <table class="titan-table">
                            <thead><tr><th>User</th><th>Best</th><th>Role</th><th>Thao tác</th></tr></thead>
                            <tbody id="admin-user-table"></tbody>
                        </table>
                    </div>
                    <div class="table-wrap">
                        <div style="padding: 20px; border-bottom: 1px solid var(--border); font-weight: 800;">QUẢN LÝ NỘI DUNG</div>
                        <table class="titan-table">
                            <thead><tr><th>Tiêu đề</th><th>Lượt</th><th>Xóa</th></tr></thead>
                            <tbody id="admin-post-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="m-post" class="modal-overlay">
        <div class="modal-box">
            <h2>Chia sẻ bài tập mới</h2>
            <div style="margin-top: 30px;">
                <label>Tiêu đề bài viết</label>
                <input type="text" id="p-title" class="form-ctrl" placeholder="Ví dụ: Truyện Kiều, Code C++...">
                <label>Nội dung văn bản (Nên dài để luyện tập tốt hơn)</label>
                <textarea id="p-content" class="form-ctrl" rows="10" placeholder="Dán văn bản của bro vào đây..."></textarea>
                <div style="display: flex; gap: 15px; justify-content: flex-end;">
                    <button class="btn-titan" style="background: var(--bg-accent);" onclick="OverlordUI.toggleModal('m-post', false)">HỦY</button>
                    <button class="btn-titan btn-p" onclick="OverlordComm.save()">CÔNG KHAI BÀI VIẾT</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /*
          ================================================================
          OVERLORD JAVASCRIPT ARCHITECTURE
          ================================================================
        */

        const RAW_DATA = "bóng đá lập trình công nghệ tương lai hạnh phúc gia đình học tập làm việc bàn phím chuột máy tính màn hình điện thoại kết nối vạn vật thông minh nhân tạo dữ liệu lớn điện toán đám mây bảo mật an ninh mạng quốc gia phát triển bền vững môi trường xanh năng lượng tái tạo du lịch khám phá văn hóa ẩm thực nghệ thuật âm nhạc phim ảnh thể thao giải trí sức khỏe y tế giáo dục đào tạo kỹ năng tư duy sáng tạo kiên trì nỗ lực thành công vĩ đại lịch sử dân tộc anh hùng chiến thắng hòa bình độc lập tự do hạnh phúc ấm no thịnh vượng vươn cao bay xa thế giới không biên giới tình hữu nghị hợp tác phát triển kinh tế tài chính đầu tư chứng khoán bất động sản khởi nghiệp kinh doanh quản trị lãnh đạo tinh thần thép ý chí kiên cường vượt qua thử thách chinh phục đỉnh cao khám phá vũ trụ khoa học kỹ thuật robot tự động hóa sản xuất thông minh nông nghiệp công nghệ cao lâm nghiệp ngư nghiệp bảo vệ rừng biển đảo chủ quyền thiêng liêng tổ quốc yêu thương chia sẻ giúp đỡ cộng đồng thiện nguyện nhân ái bao dung tôn trọng lắng nghe thấu hiểu đoàn kết sức mạnh niềm tin hy vọng khát vọng tuổi trẻ ước mơ hoài bão hành động thực tế kết quả tốt đẹp tương lai tươi sáng rạng rỡ huy hoàng thành tựu nổi bật dấu ấn cá nhân bản sắc văn hóa gìn giữ phát huy di sản thế giới nhân loại văn minh tiến bộ công bằng xã hội dân chủ văn minh giàu mạnh công bằng".split(" ");

        // --- STORAGE ENGINE ---
        class OverlordStore {
            static save(k, v) { localStorage.setItem(`titan_v120_${k}`, JSON.stringify(v)); }
            static get(k) { return JSON.parse(localStorage.getItem(`titan_v120_${k}`)); }
            static initDB() {
                if(!this.get('users')) {
                    this.save('users', {
                        'admin': { u: 'admin', p: btoa('123456'), r: 'admin', best: 120, total: 5000 },
                        'titan_god': { u: 'titan_god', p: btoa('god'), r: 'user', best: 150, total: 9999 }
                    });
                }
                if(!this.get('posts')) {
                    this.save('posts', [
                        { id: 1, t: "Hành khúc Titan", c: "Chào mừng các chiến thần đã đến với hệ thống Titan Overlord phiên bản mạnh mẽ nhất lịch sử. Đây là nơi bạn rèn luyện đôi tay sắt đá.", done: 42, words: 28 },
                        { id: 2, t: "Lời bài hát: Thuyền Quyên", c: "Thuyền quyên sao chẳng thấy bóng nàng nơi đây, chỉ thấy bóng người cũ đang đưa dâu lòng ta đau thắt khi thấy người mình yêu đi bên ai khác.", done: 85, words: 30 },
                        { id: 3, t: "Văn bản mẫu Seeding 01", c: "Bóng đá là môn thể thao vua nơi mà sự đoàn kết và kỹ thuật cá nhân được tôn vinh lên hàng đầu trong mỗi trận đấu kịch tính.", done: 12, words: 25 },
                        { id: 4, t: "Lập trình tương lai", c: "Công nghệ AI đang thay đổi thế giới từng ngày từng giờ và chúng ta cần chuẩn bị kỹ năng tốt nhất để không bị bỏ lại phía sau.", done: 5, words: 28 }
                    ]);
                }
            }
        }

        // --- AUTHENTICATION ENGINE ---
        const OverlordAuth = {
            tab(t) {
                document.querySelectorAll('.form-identity').forEach(f => f.classList.remove('active'));
                document.getElementById('auth-' + t).classList.add('active');
            },
            register() {
                const u = document.getElementById('re-user').value.trim();
                const p = document.getElementById('re-pass').value;
                if(u.length < 3 || p.length < 4) return alert("Dữ liệu quá ngắn!");
                
                let db = OverlordStore.get('users');
                if(db[u]) return alert("Tài khoản đã tồn tại!");

                db[u] = { u, p: btoa(p), r: u.toLowerCase() === 'admin' ? 'admin' : 'user', best: 0, total: 0 };
                OverlordStore.save('users', db);
                alert("Đăng ký thành công!");
                this.tab('login');
            },
            login() {
                const u = document.getElementById('in-user').value.trim();
                const p = document.getElementById('in-pass').value;
                let db = OverlordStore.get('users');

                if(db[u] && db[u].p === btoa(p)) {
                    OverlordStore.save('session', db[u]);
                    document.getElementById('auth-portal').style.display = 'none';
                    OverlordApp.init(db[u]);
                } else alert("Sai thông tin đăng nhập!");
            },
            logout() {
                localStorage.removeItem('titan_v120_session');
                location.reload();
            }
        };

        // --- TYPING ENGINE ---
        const OverlordEngine = {
            s: { active: false, words: [], idx: 0, ok: 0, err: 0, time: 60, timer: null, title: '' },

            reset(customWords = null, title = 'Văn bản ngẫu nhiên') {
                clearInterval(this.s.timer);
                this.s = { active: false, idx: 0, ok: 0, err: 0, time: 60, timer: null, title: title };
                this.s.words = customWords || Array.from({length: 150}, () => RAW_DATA[Math.floor(Math.random()*RAW_DATA.length)]);
                
                document.getElementById('stat-timer').innerText = "1:00";
                document.getElementById('stat-wpm').innerText = "0";
                document.getElementById('stat-acc').innerText = "0%";
                document.getElementById('overlord-typer').value = "";
                document.getElementById('overlord-typer').disabled = false;
                
                const rail = document.getElementById('word-rail');
                rail.style.top = "0px";
                rail.innerHTML = this.s.words.map((w, i) => `<span id="w-${i}">${w}</span>`).join('');
                document.getElementById('w-0').className = 'active-word';
                document.getElementById('overlord-typer').focus();
            },

            handle(v) {
                if(!this.s.active && v.length > 0) {
                    this.s.active = true;
                    this.s.timer = setInterval(() => {
                        this.s.time--;
                        document.getElementById('stat-timer').innerText = `0:${this.s.time < 10 ? '0' : ''}${this.s.time}`;
                        if(this.s.time <= 0) this.finish();
                    }, 1000);
                }

                if(v.endsWith(" ")) {
                    const typed = v.trim();
                    const target = this.s.words[this.s.idx];
                    const el = document.getElementById('w-' + this.s.idx);

                    if(typed === target) { el.className = 'ok'; this.s.ok++; }
                    else { el.className = 'err'; this.s.err++; }

                    this.s.idx++;
                    const next = document.getElementById('w-' + this.s.idx);
                    if(next) {
                        next.className = 'active-word';
                        if(next.offsetTop > 45) document.getElementById('word-rail').style.top = (0 - next.offsetTop) + "px";
                    }
                    document.getElementById('overlord-typer').value = "";
                    this.updateUI();
                }
            },

            updateUI() {
                document.getElementById('stat-wpm').innerText = this.s.ok;
                let acc = Math.round((this.s.ok / (this.s.ok + this.s.err)) * 100) || 0;
                document.getElementById('stat-acc').innerText = acc + "%";
            },

            finish() {
                clearInterval(this.s.timer);
                document.getElementById('overlord-typer').disabled = true;
                alert(`Kết thúc! WPM: ${this.s.ok}`);
                OverlordApp.updateRecord(this.s.ok, this.s.title);
            }
        };

        // --- COMMUNITY & ADMIN LOGIC ---
        const OverlordComm = {
            render() {
                const posts = OverlordStore.get('posts');
                document.getElementById('comm-table-body').innerHTML = posts.map(p => `
                    <tr>
                        <td><span class="admin-badge" style="background:var(--success)">PUBLIC</span></td>
                        <td>
                            <a href="#" class="btn-titan" style="padding:0; background:none; color:var(--primary);" onclick="OverlordComm.play(${p.id})">${p.t}</a>
                        </td>
                        <td><b>${p.words} từ</b></td>
                        <td>${p.done} lượt</td>
                        <td><button class="btn-mini btn-p" onclick="OverlordComm.play(${p.id})">GÕ THỬ</button></td>
                    </tr>
                `).join('');
            },
            save() {
                const t = document.getElementById('p-title').value;
                const c = document.getElementById('p-content').value;
                if(!t || c.length < 10) return alert("Nội dung bài viết quá sơ sài!");
                
                let posts = OverlordStore.get('posts');
                posts.unshift({ id: Date.now(), t, c, done: 0, words: c.split(" ").length });
                OverlordStore.save('posts', posts);
                OverlordUI.toggleModal('m-post', false);
                this.render();
            },
            play(id) {
                const p = OverlordStore.get('posts').find(x => x.id === id);
                OverlordApp.route('home');
                OverlordEngine.reset(p.c.split(" "), p.t);
            }
        };

        // --- MASTER APP CONTROL ---
        const OverlordApp = {
            user: null,

            init(u) {
                this.user = u;
                document.getElementById('user-name').innerText = u.u.toUpperCase();
                document.getElementById('user-avatar').innerText = u.u.charAt(0).toUpperCase();
                document.getElementById('user-role-badge').innerText = u.r;

                if(u.r === 'admin') {
                    document.getElementById('admin-menu-slot').innerHTML = `
                        <div class="nav-label">Admin Control</div>
                        <div class="nav-btn" onclick="OverlordApp.route('admin')" style="color:var(--danger)">
                            <i class="fa-solid fa-screwdriver-wrench"></i> QUẢN TRỊ TITAN
                        </div>
                    `;
                }

                OverlordEngine.reset();
                OverlordComm.render();
                this.startClock();
                this.renderAdminTables();
            },

            route(p) {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('v-' + p).classList.add('active');
                event.currentTarget.classList.add('active');
                document.getElementById('view-title').innerText = p.toUpperCase();
                if(p === 'admin') this.renderAdminTables();
            },

            updateRecord(wpm, title) {
                let db = OverlordStore.get('users');
                if(wpm > db[this.user.u].best) {
                    db[this.user.u].best = wpm;
                    OverlordStore.save('users', db);
                }
                if(title !== 'Văn bản ngẫu nhiên') {
                    let posts = OverlordStore.get('posts');
                    let idx = posts.findIndex(x => x.t === title);
                    if(idx !== -1) {
                        posts[idx].done++;
                        OverlordStore.save('posts', posts);
                    }
                }
            },

            renderAdminTables() {
                const users = OverlordStore.get('users');
                const posts = OverlordStore.get('posts');
                
                document.getElementById('admin-user-table').innerHTML = Object.values(users).map(u => `
                    <tr>
                        <td>${u.u}</td>
                        <td>${u.best} WPM</td>
                        <td><span class="admin-badge" style="background:${u.r === 'admin' ? 'var(--danger)' : 'var(--primary)'}">${u.r}</span></td>
                        <td><button class="btn-mini" style="background:var(--danger); color:white;" onclick="OverlordApp.deleteUser('${u.u}')">BAN</button></td>
                    </tr>
                `).join('');

                document.getElementById('admin-post-table').innerHTML = posts.map(p => `
                    <tr>
                        <td>${p.t}</td>
                        <td>${p.done}</td>
                        <td><button class="btn-mini" style="background:var(--danger); color:white;" onclick="OverlordApp.deletePost(${p.id})">XÓA</button></td>
                    </tr>
                `).join('');
            },

            deleteUser(u) { if(confirm(`Xóa user ${u}?`)) { let db = OverlordStore.get('users'); delete db[u]; OverlordStore.save('users', db); this.renderAdminTables(); } },
            deletePost(id) { if(confirm(`Xóa bài đăng này?`)) { let ps = OverlordStore.get('posts').filter(x => x.id !== id); OverlordStore.save('posts', ps); this.renderAdminTables(); OverlordComm.render(); } },

            startClock() {
                setInterval(() => document.getElementById('timer-clock').innerText = new Date().toLocaleTimeString(), 1000);
            }
        };

        const OverlordUI = {
            toggleModal(id, s) { document.getElementById(id).style.display = s ? 'flex' : 'none'; }
        };

        // --- BOOTSTRAP ---
        window.onload = () => {
            OverlordStore.initDB();
            document.getElementById('overlord-typer').addEventListener('input', (e) => OverlordEngine.handle(e.target.value));
            const session = OverlordStore.get('session');
            if(session) {
                document.getElementById('auth-portal').style.display = 'none';
                OverlordApp.init(session);
            }
        };
    </script>
</body>
</html>
