<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TYPING MASTER MONSTER EDITION V24</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #2980b9;
            --primary-dark: #1c5982;
            --secondary: #34495e;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f1c40f;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --radius-lg: 25px;
            --radius-md: 15px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Reset & Base */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Montserrat', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #d6e4f0;
            background-image: linear-gradient(135deg, #d6e4f0 0%, #ffffff 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: var(--dark);
        }

        /* Auth Modals - Cực kỳ chi tiết */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-container {
            background: var(--white);
            width: 100%;
            max-width: 420px;
            padding: 40px;
            border-radius: var(--radius-lg);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            text-align: center;
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .auth-container h2 {
            font-weight: 800;
            font-size: 28px;
            margin-bottom: 25px;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--secondary);
        }

        .auth-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #eee;
            border-radius: var(--radius-md);
            font-size: 16px;
            outline: none;
            transition: var(--transition);
        }

        .auth-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(41, 128, 185, 0.2);
        }

        .btn-main {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 800;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(41, 128, 185, 0.3);
            transition: var(--transition);
            text-transform: uppercase;
        }

        .btn-main:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Layout Structure */
        .app-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            padding: 15px;
            gap: 15px;
        }

        /* Sidebar Navigation */
        .nav-sidebar {
            width: 100%;
            background: var(--white);
            border-radius: var(--radius-md);
            padding: 10px;
            display: flex;
            flex-direction: row;
            overflow-x: auto;
            gap: 10px;
            box-shadow: var(--shadow);
            flex-shrink: 0;
            scrollbar-width: none;
        }

        .nav-sidebar::-webkit-scrollbar { display: none; }

        .menu-item {
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--secondary);
            transition: var(--transition);
        }

        .menu-item i { font-size: 18px; }
        .menu-item:hover { background: #f0f4f8; }
        .menu-item.active { background: var(--primary); color: var(--white); }

        /* Content Area */
        .content-main {
            flex-grow: 1;
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 30px;
            overflow-y: auto;
            box-shadow: var(--shadow);
            position: relative;
        }

        /* Typing Area Components */
        .typing-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .stats-top {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 15px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: var(--radius-md);
            flex: 1;
            text-align: center;
            border: 1px solid #eee;
        }

        .stat-card span { display: block; font-size: 12px; color: #7f8c8d; font-weight: 600; text-transform: uppercase; }
        .stat-card b { font-size: 24px; color: var(--dark); }

        .word-box {
            background: #fdfdfd;
            border: 2px solid #f1f1f1;
            padding: 25px;
            border-radius: var(--radius-md);
            font-size: 26px;
            line-height: 1.8;
            color: #bdc3c7;
            text-align: left;
            margin-bottom: 25px;
            min-height: 180px;
            user-select: none;
            transition: var(--transition);
        }

        .word-box span {
            display: inline-block;
            margin: 0 6px;
            position: relative;
        }

        .word-current {
            color: var(--dark);
            background: #e1eaf2;
            border-radius: 6px;
            padding: 0 8px;
            font-weight: 600;
        }

        .word-correct { color: var(--success); }
        .word-wrong { color: var(--white); background: var(--danger); border-radius: 6px; padding: 0 8px; }

        .input-zone {
            display: flex;
            gap: 15px;
            background: #e1eaf2;
            padding: 15px;
            border-radius: 20px;
            align-items: center;
        }

        .main-input {
            flex: 1;
            height: 60px;
            border-radius: 12px;
            border: none;
            padding: 0 20px;
            font-size: 22px;
            font-weight: 600;
            outline: none;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }

        .timer-display {
            width: 100px;
            height: 60px;
            background: var(--dark);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 800;
            border-radius: 12px;
        }

        .btn-refresh {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: var(--white);
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: var(--primary);
            transition: var(--transition);
        }

        .btn-refresh:hover { transform: rotate(90deg); color: var(--danger); }

        /* Pages */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Table Styles */
        .custom-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
        }

        .custom-table th {
            padding: 15px;
            text-align: left;
            color: #95a5a6;
            font-size: 14px;
            text-transform: uppercase;
        }

        .custom-table tr {
            background: #fcfcfc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            transition: var(--transition);
        }

        .custom-table tr:hover { transform: scale(1.01); background: #f8f9fa; }

        .custom-table td {
            padding: 18px 15px;
            font-weight: 600;
        }

        .custom-table tr td:first-child { border-radius: 15px 0 0 15px; }
        .custom-table tr td:last-child { border-radius: 0 15px 15px 0; }

        .rank-badge {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--light);
            border-radius: 50%;
            font-weight: 800;
            color: var(--dark);
        }

        /* Community Posts */
        .post-card {
            background: #f8f9fa;
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #eee;
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .user-info { font-weight: 800; color: var(--primary); }
        .post-content { font-size: 18px; margin-bottom: 15px; color: #444; }

        .post-actions {
            display: flex;
            gap: 10px;
        }

        /* Admin Page */
        .admin-section {
            background: #fff5f5;
            padding: 25px;
            border-radius: var(--radius-md);
            margin-bottom: 30px;
            border: 1px dashed var(--danger);
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        /* Mobile Adjustments */
        @media (min-width: 768px) {
            .app-wrapper { flex-direction: row; padding: 30px; gap: 30px; }
            .nav-sidebar { width: 300px; flex-direction: column; height: 100%; overflow-y: auto; }
            .menu-item { padding: 18px 25px; font-size: 16px; }
        }

    </style>
</head>
<body>

    <div id="auth-overlay" class="modal-overlay" style="display: flex;">
        <div id="login-box" class="auth-container">
            <h2>Đăng Nhập</h2>
            <div class="input-group">
                <label>Username</label>
                <input type="text" id="l-user" class="auth-input" placeholder="Tên tài khoản...">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="l-pass" class="auth-input" placeholder="Mật khẩu...">
            </div>
            <button class="btn-main" id="btn-login-exec">Bắt đầu ngay</button>
            <p style="margin-top:20px; font-size: 14px; font-weight:600;">
                Chưa có tài khoản? <span style="color:var(--primary); cursor:pointer" id="go-reg">Đăng ký tại đây</span>
            </p>
        </div>

        <div id="reg-box" class="auth-container" style="display: none;">
            <h2>Đăng Ký</h2>
            <div class="input-group">
                <label>Gmail</label>
                <input type="email" id="r-email" class="auth-input" placeholder="Ví dụ: abc@gmail.com">
            </div>
            <div class="input-group">
                <label>Username</label>
                <input type="text" id="r-user" class="auth-input" placeholder="Tên đăng nhập mới">
            </div>
            <div class="input-group">
                <label>Mật khẩu</label>
                <input type="password" id="r-pass" class="auth-input" placeholder="Ít nhất 6 ký tự">
            </div>
            <button class="btn-main" id="btn-reg-exec">Tạo tài khoản</button>
            <p style="margin-top:20px; font-size: 14px; font-weight:600;">
                Đã có nick? <span style="color:var(--primary); cursor:pointer" id="go-login">Đăng nhập</span>
            </p>
        </div>
    </div>

    <div class="app-wrapper">
        <div class="nav-sidebar">
            <div style="padding: 15px; text-align: center; border-bottom: 1px solid #eee; margin-bottom: 10px;" class="desktop-only">
                <h3 style="font-weight:800; color:var(--primary)">TYPING<br>PRO</h3>
            </div>
            <div class="menu-item active" data-page="1"><i class="fa-solid fa-keyboard"></i> <span id="m1-text">Luyện Gõ</span></div>
            <div class="menu-item" data-page="2"><i class="fa-solid fa-book-open"></i> <span id="m2-text">Hướng Dẫn</span></div>
            <div class="menu-item" data-page="3"><i class="fa-solid fa-trophy"></i> <span id="m3-text">Xếp Hạng</span></div>
            <div class="menu-item" data-page="4"><i class="fa-solid fa-users"></i> <span id="m4-text">Cộng Đồng</span></div>
            <div class="menu-item" data-page="profile"><i class="fa-solid fa-circle-user"></i> Hồ Sơ</div>
            <div class="menu-item" id="admin-nav" style="display:none; color:var(--danger)"><i class="fa-solid fa-user-shield"></i> God Mode</div>
            <div class="menu-item" id="btn-logout" style="margin-top:auto; color:#e67e22"><i class="fa-solid fa-right-from-bracket"></i> Đăng xuất</div>
        </div>

        <div class="content-main">
            <div id="page-1" class="page active">
                <div class="typing-container">
                    <div class="stats-top">
                        <div class="stat-card"><span>Tốc độ</span><b id="wpm-live">0</b><small> WPM</small></div>
                        <div class="stat-card"><span>Chính xác</span><b id="acc-live">0</b><small>%</small></div>
                        <div class="stat-card"><span>Kỷ lục</span><b id="best-live">0</b></div>
                    </div>
                    
                    <div id="word-display" class="word-box"></div>

                    <div class="input-zone">
                        <input type="text" id="typing-input" class="main-input" 
                               placeholder="Gõ từ tại đây..."
                               autocomplete="off" autocorrect="off" 
                               autocapitalize="off" spellcheck="false">
                        <div id="timer" class="timer-display">01:00</div>
                        <button id="refresh-typing" class="btn-refresh"><i class="fa-solid fa-rotate-right"></i></button>
                    </div>
                </div>
            </div>

            <div id="page-2" class="page">
                <h2 style="font-weight:800; margin-bottom:20px;">HƯỚNG DẪN LUYỆN TẬP</h2>
                <div style="text-align: center;">
                    <img id="tutorial-img" src="" style="width:100%; max-width:700px; border-radius:20px; box-shadow: var(--shadow); margin-bottom:25px;">
                </div>
                <div style="line-height:1.8; color:#555;">
                    <p><b>1. Tư thế ngồi:</b> Giữ lưng thẳng, mắt cách màn hình khoảng 50cm.</p>
                    <p><b>2. Đặt tay:</b> Luôn giữ các ngón tay ở hàng phím cơ sở (ASDF - JKL;).</p>
                    <p><b>3. Luyện tập:</b> Đừng nhìn bàn phím, hãy cảm nhận các phím bằng đầu ngón tay.</p>
                </div>
            </div>

            <div id="page-3" class="page">
                <h2 style="font-weight:800; margin-bottom:20px;">BẢNG VÀNG KỶ LỤC</h2>
                <p style="margin-bottom:20px; color:#666;">Top 15 cao thủ có tốc độ gõ nhanh nhất hệ thống.</p>
                <div style="overflow-x: auto;">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Hạng</th>
                                <th>Người gõ</th>
                                <th>WPM Cao Nhất</th>
                                <th>Thành tích</th>
                            </tr>
                        </thead>
                        <tbody id="rank-list"></tbody>
                    </table>
                </div>
            </div>

            <div id="page-4" class="page">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                    <h2 style="font-weight:800;">CỘNG ĐỒNG</h2>
                    <button class="btn-main" id="btn-open-post" style="width:auto; padding:12px 25px;">+ Đăng bài</button>
                </div>
                <div id="community-list"></div>
            </div>

            <div id="page-profile" class="page">
                <h2 style="font-weight:800; margin-bottom:20px;">HỒ SƠ CÁ NHÂN</h2>
                <div id="profile-card" style="background:#fcfcfc; border:1px solid #eee; padding:30px; border-radius:25px;">
                    <div style="display:flex; gap:20px; align-items:center; margin-bottom:30px;">
                        <div style="width:80px; height:80px; background:var(--primary); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:35px; font-weight:800;">
                            <span id="p-initial">U</span>
                        </div>
                        <div>
                            <h3 id="p-username" style="font-size:24px; font-weight:800;">Username</h3>
                            <p id="p-email" style="color:#7f8c8d;">email@example.com</p>
                        </div>
                    </div>
                    <div class="stats-top">
                        <div class="stat-card"><span>Kỷ lục cao nhất</span><b id="p-best" style="color:var(--primary)">0</b> WPM</div>
                        <div class="stat-card"><span>Cấp bậc</span><b id="p-rank" style="color:var(--success)">Tân binh</b></div>
                    </div>
                </div>
            </div>

            <div id="page-god" class="page">
                <h2 style="font-weight:800; color:var(--danger); margin-bottom:20px;">HỆ THỐNG QUẢN TRỊ</h2>
                
                <div class="admin-section">
                    <h4>Cấu hình giao diện</h4>
                    <div class="admin-grid">
                        <div class="input-group">
                            <label>Menu số</label>
                            <select id="adm-menu-sel" class="auth-input" style="padding:10px;">
                                <option value="1">Mục 1</option><option value="2">Mục 2</option>
                                <option value="3">Mục 3</option><option value="4">Mục 4</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Tên mới</label>
                            <input type="text" id="adm-menu-name" class="auth-input" style="padding:10px;">
                        </div>
                        <div class="input-group">
                            <label>Link ảnh hướng dẫn</label>
                            <input type="text" id="adm-img-url" class="auth-input" style="padding:10px;">
                        </div>
                    </div>
                    <button class="btn-main" id="adm-save-cfg" style="width:auto; padding:10px 30px;">Áp dụng thay đổi</button>
                </div>

                <h4>Quản lý người dùng</h4>
                <div style="overflow-x:auto;">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Password</th>
                                <th>Email</th>
                                <th>Best</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="adm-user-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. KHO TỪ VỰNG KHỔNG LỒ (500+ từ) ---
        const RAW_LIB = "anh|em|gia|đình|trường|học|máy|tính|điện|thoại|bàn|phím|chuột|màn|hình|lập|trình|thông|minh|chiến|thắng|nỗ|lực|kiên|trì|thành|công|hạnh|phúc|việt|nam|hà|nội|sài|gòn|du|lịch|biển|nước|ăn|ngon|vui|vẻ|tự|tin|sáng|tạo|lịch|sử|toán|vật|lý|hóa|học|tiếng|anh|độc|lập|tự|do|tổ|quốc|bạn|bè|sinh|nhật|lễ|hội|xuân|hạ|thu|đông|vở|viết|kiến|thức|kỹ|năng|văn|phòng|chất|lượng|tài|chính|sức|khỏe|thể|thao|bóng|đá|gym|phim|ảnh|mạng|xã|hội|chụp|hình|nhà|khách|sạn|cà|phê|trà|sữa|phở|bún|cơm|trái|cây|cam|táo|bia|rượu|mưa|nắng|gió|mây|trời|đất|sông|núi|rừng|cây|hoa|lá|vàng|bạc|đồng|sắt|thép|nhôm|kính|nhựa|giấy|bút|mực|thước|cặp|sách|bàn|ghế|giường|tủ|bếp|nồi|chảo|chén|đĩa|muỗng|đũa|khăn|áo|quần|giày|dép|mũ|nón|ví|tiền|đồng|hồ|kính|mát|nhẫn|dây|chuyền|vòng|tay|tai|nghe|loa|pin|sạc|cáp|wifi|web|app|code|game|phim|nhạc|họa|ca|múa|hát|nhảy|đàn|sáo|trống|kèn|vẽ|tô|màu|tranh|ảnh|tượng|đá|gạch|cát|vôi|xi|măng|sơn|gỗ|tre|nứa|lá|cọ|dừa|chuối|xoài|ổi|mận|đào|lê|nho|dâu|bơ|mít|dứa|khế|chanh|ớt|tỏi|hành|gừng|sả|tiêu|muối|đường|mì|chính|dầu|mỡ|thịt|cá|tôm|cua|ốc|ếch|lươn|gà|vịt|ngỗng|heo|bò|trâu|dê|cừu|ngựa|voi|hổ|báo|sư|tử|gấu|khỉ|vượn|nai|hoẵng|thỏ|chuột|mèo|chó|chim|cá|sâu|bướm|ong|kiến|gián|muỗi|ruồi|nhện|rắn|rùa|thằn|lằn|cá|vàng|cá|heo|cá|mập|cá|voi|mây|trắng|nắng|vàng|trời|xanh|biển|rộng|núi|cao|sông|dài|cánh|đồng|lúa|chín|mùa|vụ|nông|dân|vất|vả|sớm|khuya|chăm|chỉ|hiền|lành|thật|thà|dũng|cảm|trung|thực|bản|lĩnh|tài|năng|trí|tuệ|nhân|cách|giáo|dục|văn|hóa|nghệ|thuật|khoa|học|công|nghệ|phát|triển|bền|vững|môi|trường|xanh|sạch|đẹp|yêu|thương|sẻ|chia|giúp|đỡ|đoàn|kết|hòa|bình|thế|giới|tương|lai|ước|mơ|khát|vọng|đam|mê|khám|phá|thử|thách|vượt|qua|đỉnh|vinh|quang|ánh|sáng|niềm|tin|hy|vọng|tươi|đẹp|rực|rỡ|huy|hoàng|vĩ|đại|tự|hào|truyền|thống|quê|hương|đất|nước|con|người|văn|minh|hiện|đại|phương|đông|phương|tây|toàn|cầu|hội|nhập|hợp|tác|thành|tựu|cống|hiến|trách|nhiệm|nghĩa|vụ|quyền|lợi|công|bằng|dân|chủ|văn|minh".split('|');

        // --- 2. CORE APP ENGINE ---
        const typingApp = {
            currentUser: null,
            wordsToType: [],
            currentIdx: 0,
            timer: null,
            timeLeft: 60,
            isPlaying: false,
            correctWords: 0,
            wrongWords: 0,
            
            // Cấu hình từ God Mode
            config: JSON.parse(localStorage.getItem('v24_config')) || {
                m1: "Luyện Gõ", m2: "Hướng Dẫn", m3: "Xếp Hạng", m4: "Cộng Đồng",
                img2: "https://vcdn-vnexpress.vnecdn.net/2021/03/17/keyboard-1615969566-8835-1615969623.jpg"
            },

            init() {
                this.loadSession();
                this.bindEvents();
                this.updateUIStrings();
            },

            loadSession() {
                const session = localStorage.getItem('v24_session');
                if (session) {
                    this.currentUser = JSON.parse(session);
                    document.getElementById('auth-overlay').style.display = 'none';
                    this.renderSidebar();
                    this.switchPage(1);
                }
            },

            bindEvents() {
                // Auth navigation
                document.getElementById('go-reg').onclick = () => {
                    document.getElementById('login-box').style.display = 'none';
                    document.getElementById('reg-box').style.display = 'block';
                };
                document.getElementById('go-login').onclick = () => {
                    document.getElementById('reg-box').style.display = 'none';
                    document.getElementById('login-box').style.display = 'block';
                };

                // Auth execution
                document.getElementById('btn-login-exec').onclick = () => this.handleLogin();
                document.getElementById('btn-reg-exec').onclick = () => this.handleRegister();
                document.getElementById('btn-logout').onclick = () => this.handleLogout();

                // Navigation
                document.querySelectorAll('.menu-item[data-page]').forEach(item => {
                    item.onclick = (e) => {
                        const pageId = e.currentTarget.getAttribute('data-page');
                        this.switchPage(pageId);
                    };
                });

                // Typing logic
                document.getElementById('typing-input').oninput = (e) => this.handleTypingInput(e);
                document.getElementById('refresh-typing').onclick = () => this.resetTypingEngine();

                // Admin
                document.getElementById('adm-save-cfg').onclick = () => this.saveAdminConfig();
                
                // Community
                document.getElementById('btn-open-post').onclick = () => this.createNewPost();
            },

            updateUIStrings() {
                document.getElementById('m1-text').innerText = this.config.m1;
                document.getElementById('m2-text').innerText = this.config.m2;
                document.getElementById('m3-text').innerText = this.config.m3;
                document.getElementById('m4-text').innerText = this.config.m4;
                document.getElementById('tutorial-img').src = this.config.img2;
            },

            handleRegister() {
                const e = document.getElementById('r-email').value.trim();
                const u = document.getElementById('r-user').value.trim();
                const p = document.getElementById('r-pass').value.trim();

                if (!u || !p || p.length < 6) return alert("Vui lòng điền đủ và Pass > 6 ký tự!");
                if (localStorage.getItem('v24_user_' + u)) return alert("Username đã tồn tại!");

                const userData = { email: e, pass: p, best: 0, joined: new Date().toLocaleDateString() };
                localStorage.setItem('v24_user_' + u, JSON.stringify(userData));
                alert("Đăng ký thành công! Đăng nhập đi bro.");
                document.getElementById('go-login').click();
            },

            handleLogin() {
                const u = document.getElementById('l-user').value.trim();
                const p = document.getElementById('l-pass').value.trim();

                if (u === 'nhtseri' && p === 'Locthinh1!') {
                    this.currentUser = { username: u, isAdmin: true, email: 'god@admin.com', best: 999 };
                } else {
                    const saved = localStorage.getItem('v24_user_' + u);
                    if (!saved) return alert("User không tồn tại!");
                    const parsed = JSON.parse(saved);
                    if (parsed.pass !== p) return alert("Sai mật khẩu!");
                    this.currentUser = { username: u, isAdmin: false, email: parsed.email, best: parsed.best || 0 };
                }

                localStorage.setItem('v24_session', JSON.stringify(this.currentUser));
                location.reload();
            },

            handleLogout() {
                localStorage.removeItem('v24_session');
                location.reload();
            },

            renderSidebar() {
                if (this.currentUser.isAdmin) {
                    document.getElementById('admin-nav').style.display = 'flex';
                }
            },

            switchPage(id) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
                
                const target = document.getElementById('page-' + id);
                if (target) target.classList.add('active');
                
                const menuTarget = document.querySelector(`.menu-item[data-page="${id}"]`);
                if (menuTarget) menuTarget.classList.add('active');

                if (id == 1) this.resetTypingEngine();
                if (id == 3) this.renderRankTable();
                if (id == 4) this.renderCommunity();
                if (id == 'profile') this.renderProfile();
                if (id == 'god') this.renderAdminTools();
            },

            // --- 3. TYPING CORE LOGIC ---
            resetTypingEngine(customArr = null) {
                clearInterval(this.timer);
                this.isPlaying = false;
                this.timeLeft = 60;
                this.currentIdx = 0;
                this.correctWords = 0;
                this.wrongWords = 0;

                document.getElementById('timer').innerText = "01:00";
                document.getElementById('typing-input').value = "";
                document.getElementById('typing-input').disabled = false;
                document.getElementById('wpm-live').innerText = "0";
                document.getElementById('acc-live').innerText = "0";
                document.getElementById('best-live').innerText = this.currentUser.best;

                if (customArr) {
                    this.wordsToType = customArr;
                } else {
                    // Random 50 từ từ kho
                    this.wordsToType = [...RAW_LIB].sort(() => 0.5 - Math.random()).slice(0, 50);
                }

                this.renderWords();
            },

            renderWords() {
                const container = document.getElementById('word-display');
                container.innerHTML = this.wordsToType.map((w, i) => {
                    return `<span id="word-${i}" class="${i === 0 ? 'word-current' : ''}">${w}</span>`;
                }).join("");
            },

            handleTypingInput(e) {
                if (!this.isPlaying) {
                    this.isPlaying = true;
                    this.startCountdown();
                }

                const input = e.target.value;
                
                // Khi người dùng nhấn Space
                if (input.endsWith(" ")) {
                    const typedWord = input.trim().toLowerCase(); // FIX MOBILE AUTO-CAP
                    const targetWord = this.wordsToType[this.currentIdx].toLowerCase();
                    const el = document.getElementById('word-' + this.currentIdx);

                    if (typedWord === targetWord) {
                        el.className = 'word-correct';
                        this.correctWords++;
                    } else {
                        el.className = 'word-wrong';
                        this.wrongWords++;
                    }

                    this.currentIdx++;
                    
                    // Cập nhật từ tiếp theo
                    if (this.currentIdx < this.wordsToType.length) {
                        const nextEl = document.getElementById('word-' + this.currentIdx);
                        nextEl.className = 'word-current';
                        nextEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                        this.endGame();
                    }

                    e.target.value = "";
                    this.updateLiveStats();
                }
            },

            updateLiveStats() {
                const total = this.correctWords + this.wrongWords;
                const acc = total === 0 ? 0 : Math.round((this.correctWords / total) * 100);
                document.getElementById('wpm-live').innerText = this.correctWords;
                document.getElementById('acc-live').innerText = acc;
            },

            startCountdown() {
                this.timer = setInterval(() => {
                    this.timeLeft--;
                    let m = Math.floor(this.timeLeft / 60);
                    let s = this.timeLeft % 60;
                    document.getElementById('timer').innerText = `${m < 10 ? '0' + m : m}:${s < 10 ? '0' + s : s}`;

                    if (this.timeLeft <= 0) this.endGame();
                }, 1000);
            },

            endGame() {
                clearInterval(this.timer);
                document.getElementById('typing-input').disabled = true;
                const finalWpm = this.correctWords;
                alert(`Kết thúc! Tốc độ của bạn: ${finalWpm} WPM`);

                // Cập nhật kỷ lục cá nhân
                if (finalWpm > this.currentUser.best) {
                    this.currentUser.best = finalWpm;
                    localStorage.setItem('v24_session', JSON.stringify(this.currentUser));
                    
                    // Lưu vào DB Local
                    const dbData = JSON.parse(localStorage.getItem('v24_user_' + this.currentUser.username));
                    if (dbData) {
                        dbData.best = finalWpm;
                        localStorage.setItem('v24_user_' + this.currentUser.username, JSON.stringify(dbData));
                    }
                }

                // Cập nhật BXH toàn cục
                this.updateGlobalRank(this.currentUser.username, finalWpm);
                this.resetTypingEngine();
            },

            // --- 4. RANKING ENGINE (Cực kỳ quan trọng) ---
            updateGlobalRank(user, wpm) {
                let ranks = JSON.parse(localStorage.getItem('v24_global_ranks') || "[]");
                
                // Logic: 1 Người 1 Top
                const existIdx = ranks.findIndex(r => r.u === user);
                if (existIdx !== -1) {
                    // Nếu kỷ lục mới cao hơn mới ghi đè
                    if (wpm > ranks[existIdx].w) {
                        ranks[existIdx].w = wpm;
                        ranks[existIdx].d = new Date().toLocaleDateString();
                    }
                } else {
                    ranks.push({ u: user, w: wpm, d: new Date().toLocaleDateString() });
                }

                // Sắp xếp
                ranks.sort((a, b) => b.w - a.w);
                // Lấy Top 15
                localStorage.setItem('v24_global_ranks', JSON.stringify(ranks.slice(0, 15)));
            },

            renderRankTable() {
                const ranks = JSON.parse(localStorage.getItem('v24_global_ranks') || "[]");
                const tbody = document.getElementById('rank-list');
                tbody.innerHTML = ranks.map((r, i) => `
                    <tr>
                        <td><div class="rank-badge">${i+1}</div></td>
                        <td><i class="fa-solid fa-user" style="margin-right:8px; color:#bdc3c7"></i> ${r.u}</td>
                        <td style="color:var(--primary); font-size:18px;">${r.w} <small>WPM</small></td>
                        <td><small>${r.d}</small></td>
                    </tr>
                `).join("");
            },

            // --- 5. COMMUNITY LOGIC ---
            renderCommunity() {
                const posts = JSON.parse(localStorage.getItem('v24_posts') || "[]");
                const container = document.getElementById('community-list');
                
                if (posts.length === 0) {
                    container.innerHTML = `<div style="text-align:center; padding:50px; color:#ccc;">Chưa có bài đăng nào.</div>`;
                    return;
                }

                container.innerHTML = posts.map((p, i) => {
                    const isLiked = p.likers && p.likers.includes(this.currentUser.username);
                    return `
                        <div class="post-card">
                            <div class="post-header">
                                <span class="user-info">@${p.author}</span>
                                <span style="font-size:12px; color:#999;">${p.date}</span>
                            </div>
                            <div class="post-content">${p.content}</div>
                            <div class="post-actions">
                                <button class="btn-sm" style="background:${isLiked ? 'var(--danger)' : '#eee'}; color:${isLiked ? 'white' : '#666'};" onclick="typingApp.likePost(${i})">
                                    <i class="fa-solid fa-heart"></i> ${p.likes || 0}
                                </button>
                                <button class="btn-sm" style="background:var(--success); color:white;" onclick="typingApp.tryPostContent(${i})">
                                    Gõ thử bài này
                                </button>
                            </div>
                        </div>
                    `;
                }).join("");
            },

            createNewPost() {
                const content = prompt("Nhập nội dung bạn muốn chia sẻ để mọi người cùng gõ:");
                if (content && content.trim().length > 5) {
                    const posts = JSON.parse(localStorage.getItem('v24_posts') || "[]");
                    posts.unshift({
                        author: this.currentUser.username,
                        content: content.trim(),
                        likes: 0,
                        likers: [],
                        date: new Date().toLocaleString()
                    });
                    localStorage.setItem('v24_posts', JSON.stringify(posts));
                    this.renderCommunity();
                } else {
                    alert("Nội dung quá ngắn bro!");
                }
            },

            likePost(idx) {
                const posts = JSON.parse(localStorage.getItem('v24_posts'));
                const p = posts[idx];
                if (!p.likers) p.likers = [];

                const userIdx = p.likers.indexOf(this.currentUser.username);
                if (userIdx === -1) {
                    p.likers.push(this.currentUser.username);
                    p.likes = (p.likes || 0) + 1;
                } else {
                    p.likers.splice(userIdx, 1);
                    p.likes -= 1;
                }
                localStorage.setItem('v24_posts', JSON.stringify(posts));
                this.renderCommunity();
            },

            tryPostContent(idx) {
                const posts = JSON.parse(localStorage.getItem('v24_posts'));
                const content = posts[idx].content;
                const wordArr = content.split(/\s+/).filter(w => w.length > 0);
                this.switchPage(1);
                this.resetTypingEngine(wordArr);
            },

            // --- 6. PROFILE & ADMIN ---
            renderProfile() {
                document.getElementById('p-initial').innerText = this.currentUser.username[0].toUpperCase();
                document.getElementById('p-username').innerText = this.currentUser.username;
                document.getElementById('p-email').innerText = this.currentUser.email;
                document.getElementById('p-best').innerText = this.currentUser.best;
                
                let rankName = "Tân binh";
                if(this.currentUser.best > 40) rankName = "Tay gõ nghiệp dư";
                if(this.currentUser.best > 70) rankName = "Kiện tướng gõ máy";
                if(this.currentUser.best > 100) rankName = "Thánh tốc độ";
                document.getElementById('p-rank').innerText = rankName;
            },

            renderAdminTools() {
                const tbody = document.getElementById('adm-user-list');
                let html = "";
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('v24_user_')) {
                        const u = key.replace('v24_user_', '');
                        const d = JSON.parse(localStorage.getItem(key));
                        html += `
                            <tr>
                                <td>${u}</td>
                                <td><code>${d.pass}</code></td>
                                <td>${d.email}</td>
                                <td>${d.best} WPM</td>
                                <td><button onclick="typingApp.deleteUser('${key}')" style="color:red; border:none; background:none; cursor:pointer;"><i class="fa-solid fa-trash"></i></button></td>
                            </tr>
                        `;
                    }
                }
                tbody.innerHTML = html;
            },

            saveAdminConfig() {
                const m = document.getElementById('adm-menu-sel').value;
                const name = document.getElementById('adm-menu-name').value.trim();
                const img = document.getElementById('adm-img-url').value.trim();

                if (name) this.config['m' + m] = name;
                if (img && m == '2') this.config.img2 = img;

                localStorage.setItem('v24_config', JSON.stringify(this.config));
                alert("Đã cập nhật cấu hình hệ thống!");
                location.reload();
            },

            deleteUser(key) {
                if (confirm("Xóa vĩnh viễn user này?")) {
                    localStorage.removeItem(key);
                    this.renderAdminTools();
                }
            }
        };

        // Khởi tạo App
        window.onload = () => typingApp.init();

    </script>
</body>
</html>
